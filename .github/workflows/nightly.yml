name: Nightly

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  extended-tests:
    name: Extended Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Run unit tests
        working-directory: zippy-remote
        run: cargo test --all-features --workspace --lib
      
      - name: Run integration tests
        working-directory: zippy-remote
        run: cargo test --all-features --workspace --test '*'
      
      - name: Run property-based tests
        working-directory: zippy-remote
        run: |
          # Run property-based tests for crypto modules
          cargo test --package zrc-crypto --all-features -- --nocapture || true
          cargo test --package zrc-core --all-features -- --nocapture || true
        continue-on-error: true
      
      - name: Run extended test suite
        working-directory: zippy-remote
        run: |
          # Run tests with extended timeouts and more iterations
          cargo test --all-features --workspace -- --test-threads=1 --nocapture
        continue-on-error: true

  property-tests-crypto:
    name: Property Tests - Crypto
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Run crypto property tests
        working-directory: zippy-remote
        env:
          PROPTEST_CASES: 10000
        run: |
          cargo test --package zrc-crypto --all-features -- --nocapture
        continue-on-error: true

  dependency-update-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      
      - name: Check for outdated dependencies
        working-directory: zippy-remote
        run: |
          cargo outdated --exit-code 0 --format json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "Found outdated dependencies:"
            cat outdated.json
            echo "::notice title=Dependency Updates::Some dependencies have updates available. Review outdated.json for details."
          else
            echo "All dependencies are up to date"
          fi
        continue-on-error: true
      
      - name: Upload outdated dependencies report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: zippy-remote/outdated.json
          if-no-files-found: ignore
          retention-days: 7

  fuzz-testing:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked
      
      - name: Run fuzz tests
        working-directory: zippy-remote
        run: |
          # Check if fuzz targets exist
          if [ -d "fuzz" ]; then
            cargo fuzz run --all-targets -- -max_total_time=300 || true
          else
            echo "No fuzz targets found, skipping fuzz testing"
          fi
        continue-on-error: true

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Run benchmarks
        working-directory: zippy-remote
        run: |
          # Check if benchmarks exist
          if cargo bench --help > /dev/null 2>&1; then
            cargo bench --all-features --workspace || true
          else
            echo "No benchmarks found, skipping"
          fi
        continue-on-error: true
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: zippy-remote/target/criterion
          if-no-files-found: ignore
          retention-days: 7
