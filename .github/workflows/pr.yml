name: PR Validation

on:
  pull_request:
    branches: [main, develop]

concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

env:
  # Cross-platform crates that can be tested on any OS
  CROSS_PLATFORM_CRATES: >-
    -p zrc-proto
    -p zrc-crypto
    -p zrc-core
    -p zrc-transport
    -p zrc-relay
    -p zrc-rendezvous
    -p zrc-dirnode
    -p zrc-controller
    -p zrc-updater
    -p zrc-admin-console
    -p zrc-security

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Check formatting
        working-directory: zippy-remote
        run: cargo fmt --all -- --check
      
      - name: Clippy (cross-platform crates)
        working-directory: zippy-remote
        run: cargo clippy ${{ env.CROSS_PLATFORM_CRATES }} --all-targets -- -D warnings

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform_crate: zrc-platform-linux
          - os: windows-latest
            platform_crate: zrc-platform-win
          - os: macos-latest
            platform_crate: zrc-platform-mac
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Test cross-platform crates
        working-directory: zippy-remote
        run: cargo test ${{ env.CROSS_PLATFORM_CRATES }}
      
      - name: Test platform-specific crate
        working-directory: zippy-remote
        run: cargo test -p ${{ matrix.platform_crate }}
      
      - name: Test desktop crate
        working-directory: zippy-remote
        run: cargo test -p zrc-desktop
      
      - name: Test agent crate
        working-directory: zippy-remote
        run: cargo test -p zrc-agent

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Security audit
        working-directory: zippy-remote
        run: cargo audit

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked
      
      - name: Generate coverage (cross-platform crates)
        working-directory: zippy-remote
        run: |
          cargo llvm-cov ${{ env.CROSS_PLATFORM_CRATES }} -p zrc-platform-linux \
            --lcov --output-path lcov.info
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: zippy-remote/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Build documentation
        working-directory: zippy-remote
        env:
          RUSTDOCFLAGS: -D warnings
        run: cargo doc ${{ env.CROSS_PLATFORM_CRATES }} --no-deps

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, test, security, coverage, doc]
    if: failure()
    steps:
      - name: Notify failure
        run: |
          echo "::error::One or more PR validation checks failed"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
