name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  # Binaries to build on each platform
  WINDOWS_BINS: >-
    --bin zrc-agent
    --bin zrc-desktop
    --bin zrc-dirnode
    --bin zrc-relay
    --bin zrc-rendezvous
    --bin zrc-admin-console
  # Note: zrc-agent and zrc-desktop excluded until platform crates are wired up
  MACOS_BINS: >-
    --bin zrc-dirnode
    --bin zrc-relay
    --bin zrc-rendezvous
    --bin zrc-admin-console
  # Note: zrc-agent and zrc-desktop excluded until platform crates are wired up
  LINUX_BINS: >-
    --bin zrc-dirnode
    --bin zrc-relay
    --bin zrc-rendezvous
    --bin zrc-admin-console

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if [ -f "CHANGELOG.md" ]; then
            # Extract changelog section for this version
            awk "/^## \[$VERSION\]/,/^## \[/" CHANGELOG.md | sed '$d' > changelog_section.txt
            CHANGELOG_CONTENT=$(cat changelog_section.txt || echo "Release $VERSION")
          else
            CHANGELOG_CONTENT="Release $VERSION"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.content }}
          draft: true
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build admin console frontend
        working-directory: zippy-remote/crates/zrc-admin-console/web
        run: |
          npm ci
          npm run build
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
          shared-key: v2-windows
      
      - name: Build release
        working-directory: zippy-remote
        run: cargo build --release --target x86_64-pc-windows-msvc ${{ env.WINDOWS_BINS }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: zippy-remote/target/x86_64-pc-windows-msvc/release/*.exe
          retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build admin console frontend
        working-directory: zippy-remote/crates/zrc-admin-console/web
        run: |
          npm ci
          npm run build
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
          shared-key: v2-macos
      
      - name: Build x86_64
        working-directory: zippy-remote
        run: cargo build --release --target x86_64-apple-darwin ${{ env.MACOS_BINS }}
      
      - name: Build arm64
        working-directory: zippy-remote
        run: cargo build --release --target aarch64-apple-darwin ${{ env.MACOS_BINS }}
      
      - name: Create universal binaries
        working-directory: zippy-remote
        run: |
          mkdir -p target/universal/release
          for bin in zrc-agent zrc-controller zrc-desktop zrc-dirnode zrc-relay zrc-rendezvous; do
            if [ -f "target/x86_64-apple-darwin/release/$bin" ] && [ -f "target/aarch64-apple-darwin/release/$bin" ]; then
              lipo -create \
                target/x86_64-apple-darwin/release/$bin \
                target/aarch64-apple-darwin/release/$bin \
                -output target/universal/release/$bin
            fi
          done
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: zippy-remote/target/universal/release/*
          retention-days: 30

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, x86_64-linux-android
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Build native libraries
        working-directory: zippy-remote
        run: |
          cargo build --release --target aarch64-linux-android -p zrc-platform-android
          cargo build --release --target x86_64-linux-android -p zrc-platform-android
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - name: Copy native libraries
        run: |
          mkdir -p android-app/app/src/main/jniLibs/arm64-v8a
          mkdir -p android-app/app/src/main/jniLibs/x86_64
          cp zippy-remote/target/aarch64-linux-android/release/libzrc_android.so android-app/app/src/main/jniLibs/arm64-v8a/ 2>/dev/null || true
          cp zippy-remote/target/x86_64-linux-android/release/libzrc_android.so android-app/app/src/main/jniLibs/x86_64/ 2>/dev/null || true
      
      - name: Build APK
        working-directory: android-app
        run: ./gradlew assembleRelease
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: android-app/app/build/outputs/apk/release/*.apk
          retention-days: 30

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios, aarch64-apple-ios-sim
      
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: zippy-remote
      
      - name: Build iOS library
        working-directory: zippy-remote
        run: |
          cargo build --release --target aarch64-apple-ios -p zrc-platform-ios
          cargo build --release --target aarch64-apple-ios-sim -p zrc-platform-ios
      
      - name: Create XCFramework
        working-directory: zippy-remote
        run: |
          mkdir -p target/ios-frameworks
          xcodebuild -create-xcframework \
            -library target/aarch64-apple-ios/release/libzrc_ios.a \
            -library target/aarch64-apple-ios-sim/release/libzrc_ios.a \
            -output target/ios-frameworks/ZrcCore.xcframework
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-xcframework
          path: zippy-remote/target/ios-frameworks/ZrcCore.xcframework
          retention-days: 30

  sign-windows:
    name: Sign Windows
    needs: [create-release, build-windows]
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-x64
          path: artifacts
      
      - name: Sign with Authenticode
        env:
          SIGNING_CERT: ${{ secrets.WINDOWS_SIGNING_CERT }}
          SIGNING_KEY: ${{ secrets.WINDOWS_SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.WINDOWS_SIGNING_PASSWORD }}
        run: |
          if ($env:SIGNING_CERT -and $env:SIGNING_KEY) {
            # Import certificate from base64
            $certBytes = [System.Convert]::FromBase64String($env:SIGNING_CERT)
            $cert = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new($certBytes, $env:SIGNING_PASSWORD)
            
            # Export to PFX for signing
            $pfxBytes = $cert.Export([System.Security.Cryptography.X509Certificates.X509ContentType]::Pkcs12, $env:SIGNING_PASSWORD)
            $pfxPath = "cert.pfx"
            [System.IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
            
            # Sign all executables
            Get-ChildItem -Path artifacts -Filter *.exe | ForEach-Object {
              Write-Host "Signing $($_.Name)..."
              Set-AuthenticodeSignature -FilePath $_.FullName `
                -Certificate $cert `
                -TimestampServer "http://timestamp.digicert.com" `
                -HashAlgorithm SHA256
            }
          } else {
            Write-Host "Skipping signing - certificates not configured"
          }
      
      - name: Verify signatures
        run: |
          Get-ChildItem -Path artifacts -Filter *.exe | ForEach-Object {
            $sig = Get-AuthenticodeSignature $_.FullName
            if ($sig.Status -ne "Valid") {
              Write-Warning "Signature verification failed for $($_.Name): $($sig.Status)"
            } else {
              Write-Host "Signature verified for $($_.Name)"
            }
          }
      
      - name: Upload signed artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notarize-macos:
    name: Notarize macOS
    needs: [create-release, build-macos]
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: artifacts
      
      - name: Import certificates
        env:
          APPLE_CERT: ${{ secrets.APPLE_DEVELOPER_CERT }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          if [ -n "$APPLE_CERT" ]; then
            echo "$APPLE_CERT" | base64 --decode > cert.p12
            security create-keychain -p "" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            security import cert.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          else
            echo "Skipping certificate import - not configured"
          fi
      
      - name: Sign binaries
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -n "$APPLE_TEAM_ID" ]; then
            find artifacts -type f -perm +111 | while read binary; do
              echo "Signing $binary..."
              codesign --force --options runtime --sign "Developer ID Application: $APPLE_TEAM_ID" "$binary"
            done
          else
            echo "Skipping signing - not configured"
          fi
      
      - name: Create ZIP for notarization
        run: |
          cd artifacts
          zip -r ../notarize.zip *
          cd ..
      
      - name: Submit for notarization
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_PASSWORD" ]; then
            xcrun notarytool submit notarize.zip \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
          else
            echo "Skipping notarization - credentials not configured"
          fi
      
      - name: Staple notarization ticket
        run: |
          if [ -f "notarize.zip" ]; then
            find artifacts -type f -perm +111 | while read binary; do
              xcrun stapler staple "$binary" || true
            done
          fi
      
      - name: Upload signed artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sign-android:
    name: Sign Android
    needs: [create-release, build-android]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: android
          path: artifacts
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - name: Sign APK
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$ANDROID_KEYSTORE" ]; then
            echo "$ANDROID_KEYSTORE" | base64 --decode > release.keystore
            find artifacts -name "*.apk" | while read apk; do
              echo "Signing $apk..."
              jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
                -keystore release.keystore \
                -storepass "$ANDROID_KEYSTORE_PASSWORD" \
                -keypass "$ANDROID_KEY_PASSWORD" \
                "$apk" "$ANDROID_KEY_ALIAS"
              
              # Align APK
              zipalign -v 4 "$apk" "${apk}.aligned"
              mv "${apk}.aligned" "$apk"
            done
          else
            echo "Skipping APK signing - keystore not configured"
          fi
      
      - name: Generate AAB
        working-directory: android-app
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$ANDROID_KEYSTORE" ]; then
            echo "$ANDROID_KEYSTORE" | base64 --decode > release.keystore
            ./gradlew bundleRelease \
              -Pandroid.injected.signing.store.file=release.keystore \
              -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
              -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
              -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"
          else
            echo "Skipping AAB generation - keystore not configured"
          fi
      
      - name: Upload signed artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*
            android-app/app/build/outputs/bundle/release/*.aab
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sign-ios:
    name: Sign iOS
    needs: [create-release, build-ios]
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-xcframework
          path: artifacts
      
      - name: Import certificates
        env:
          APPLE_CERT: ${{ secrets.APPLE_DISTRIBUTION_CERT }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          if [ -n "$APPLE_CERT" ]; then
            echo "$APPLE_CERT" | base64 --decode > cert.p12
            security create-keychain -p "" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            security import cert.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          else
            echo "Skipping certificate import - not configured"
          fi
      
      - name: Sign XCFramework
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          if [ -n "$APPLE_TEAM_ID" ]; then
            find artifacts -name "*.xcframework" | while read framework; do
              echo "Signing $framework..."
              codesign --force --sign "Apple Distribution: $APPLE_TEAM_ID" "$framework"
            done
          else
            echo "Skipping signing - not configured"
          fi
      
      - name: Upload signed artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-sbom:
    name: Generate SBOM
    needs: [create-release]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Generate checksums
        working-directory: zippy-remote
        run: |
          # Generate checksums for source
          find . -name "*.rs" -o -name "Cargo.toml" | xargs sha256sum > checksums.txt || true
      
      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          files: zippy-remote/checksums.txt
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-update-manifest:
    name: Generate Update Manifest
    needs: [sign-windows, notarize-macos, sign-android, sign-ios, create-release, generate-sbom]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '*'
          merge-multiple: true
      
      - name: Generate checksums
        run: |
          find artifacts -type f | while read file; do
            sha256sum "$file" >> checksums.txt
          done
      
      - name: Generate update manifest
        id: manifest
        env:
          VERSION: ${{ needs.create-release.outputs.version }}
        run: |
          cat > manifest.json << EOF
          {
            "version": "$VERSION",
            "channel": "stable",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "windows-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/zrc-agent-windows-x64.exe",
                "sha256": "$(grep -i 'windows.*\.exe' checksums.txt | head -1 | awk '{print $1}' || echo '')",
                "size": $(stat -c%s artifacts/*.exe 2>/dev/null | head -1 || echo 0)
              },
              "macos-universal": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/zrc-agent-macos-universal",
                "sha256": "$(grep -i 'macos' checksums.txt | head -1 | awk '{print $1}' || echo '')",
                "size": $(stat -c%s artifacts/* 2>/dev/null | head -1 || echo 0)
              }
            }
          }
          EOF
          cat manifest.json
      
      - name: Sign manifest
        env:
          RELEASE_KEY: ${{ secrets.RELEASE_SIGNING_KEY }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_SIGNING_KEY_PASSWORD }}
        run: |
          if [ -n "$RELEASE_KEY" ]; then
            echo "$RELEASE_KEY" > release-key.pem
            openssl dgst -sha256 -sign release-key.pem -out manifest.sig manifest.json
          else
            echo "Skipping manifest signing - key not configured"
            touch manifest.sig
          fi
      
      - name: Upload manifest
        uses: softprops/action-gh-release@v1
        with:
          files: |
            manifest.json
            manifest.sig
            checksums.txt
          tag_name: ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to update server
        if: env.UPDATE_SERVER_URL != ''
        env:
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          UPDATE_SERVER_KEY: ${{ secrets.UPDATE_SERVER_KEY }}
        run: |
          if [ -n "$UPDATE_SERVER_URL" ]; then
            curl -X PUT "$UPDATE_SERVER_URL/stable/manifest.json" \
              -H "Authorization: Bearer $UPDATE_SERVER_KEY" \
              -H "Content-Type: application/json" \
              --data-binary @manifest.json
            curl -X PUT "$UPDATE_SERVER_URL/stable/manifest.sig" \
              -H "Authorization: Bearer $UPDATE_SERVER_KEY" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @manifest.sig
          else
            echo "Skipping update server upload - URL not configured"
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [create-release, build-windows, build-macos, build-android, build-ios, sign-windows, notarize-macos, sign-android, sign-ios, generate-sbom, generate-update-manifest]
    if: failure()
    steps:
      - name: Notify failure
        run: |
          echo "::error::Release workflow failed"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Tag: ${{ github.ref_name }}"
