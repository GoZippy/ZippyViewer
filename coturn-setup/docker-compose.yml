version: '3.8'

services:
  coturn:
    image: coturn/coturn:latest
    container_name: zrc-coturn
    restart: unless-stopped
    network_mode: host  # Required for TURN to work correctly with NAT
    volumes:
      - ./turnserver.conf:/etc/turnserver.conf:ro
      - ./certs:/etc/coturn/certs:ro
      - ./logs:/var/log/coturn
    environment:
      - EXTERNAL_IP=${EXTERNAL_IP}
      - TURN_SECRET=${TURN_SECRET}
      - REALM=${REALM:-zrc.local}
      - LISTENING_IP=${LISTENING_IP:-0.0.0.0}
      - LISTENING_PORT=${LISTENING_PORT:-3478}
      - TLS_LISTENING_PORT=${TLS_LISTENING_PORT:-5349}
      - MAX_BPS=${MAX_BPS:-10000000}
      - MAX_ALLOCATIONS=${MAX_ALLOCATIONS:-1000}
      - USER_QUOTA=${USER_QUOTA:-12}
    command: ["-c", "/etc/turnserver.conf"]
    healthcheck:
      test: ["CMD", "turnutils_stunclient", "127.0.0.1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    user: "65534:65534"  # Run as non-root user (nobody)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to privileged ports
